<template>
  <div id="relation"></div>
</template>
<script>
import * as d3 from "d3";
export default {
  mounted() {
    const relationCell = {
      name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
      title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
      children: [],
      relation: [],
      info: {
        type: "æ¨è¿›ä¸­",
        name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
        person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
        with: "å¾å©·ã€ç‹ä½³",
        finishTime: "2021-05-06",
      },
    };
    const relationBasicData = {
      name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
      title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
      children: [
        {
          name: "ç‰µå¤´å•ä½ï¼šç ”å‘äºŒéƒ¨",
          title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
          children: [
            {
              name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸‰éƒ¨",
              title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
              children: [
                {
                  name: "ç‰µå¤´å•ä½ï¼šç ”å‘å››éƒ¨",
                  title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
                  children: [relationCell, relationCell],
                  relation: [
                    {
                      name: "ç‰µå¤´å•ä½ï¼šå·¥ç¨‹é¡¹ç›®ç»„",
                      task: "å…³è”ä»»åŠ¡ï¼šå®Œæˆæ–°å»ºå…¬åŠ¡æœºæ£šé¡¹ç›®ç»“ç®—",
                    },
                    {
                      name: "ç‰µå¤´å•ä½ï¼šå·¥ç¨‹é¡¹ç›®ç»„",
                      task: "å…³è”ä»»åŠ¡ï¼šå®Œæˆæ–°å»ºå…¬åŠ¡æœºæ£šé¡¹ç›®ç»“ç®—",
                    },
                  ],
                  info: {
                    type: "æ¨è¿›ä¸­",
                    name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
                    person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
                    with: "å¾å©·ã€ç‹ä½³",
                    finishTime: "2021-05-06",
                  },
                },
              ],
              relation: [],
              info: {
                type: "æ¨è¿›ä¸­",
                name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
                person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
                with: "å¾å©·ã€ç‹ä½³",
                finishTime: "2021-05-06",
              },
            },
            {
              name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
              title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
              children: [],
              relation: [],
              info: {
                type: "æ¨è¿›ä¸­",
                name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
                person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
                with: "å¾å©·ã€ç‹ä½³",
                finishTime: "2021-05-06",
              },
            },
          ],
          relation: [
            {
              name: "ç‰µå¤´å•ä½ï¼šå·¥ç¨‹é¡¹ç›®ç»„",
              task: "å…³è”ä»»åŠ¡ï¼šå®Œæˆæ–°å»ºå…¬åŠ¡æœºæ£šé¡¹ç›®ç»“ç®—",
            },
            {
              name: "ç‰µå¤´å•ä½ï¼šå·¥ç¨‹é¡¹ç›®ç»„",
              task: "å…³è”ä»»åŠ¡ï¼šå®Œæˆæ–°å»ºå…¬åŠ¡æœºæ£šé¡¹ç›®ç»“ç®—",
            },
            {
              name: "ç‰µå¤´å•ä½ï¼šå·¥ç¨‹é¡¹ç›®ç»„",
              task: "å…³è”ä»»åŠ¡ï¼šå®Œæˆæ–°å»ºå…¬åŠ¡æœºæ£šé¡¹ç›®ç»“ç®—",
            },
          ],
          info: {
            type: "æ¨è¿›ä¸­",
            name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
            person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
            with: "å¾å©·ã€ç‹ä½³",
            finishTime: "2021-05-06",
          },
        },
        {
          name: "ç‰µå¤´å•ä½ï¼šç ”å‘09éƒ¨",
          title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
          children: [
            {
              name: "ç‰µå¤´å•ä½ï¼šç ”å‘08éƒ¨",
              title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
              children: [
                relationCell,
                {
                  name: "ç‰µå¤´å•ä½ï¼šç ”å‘07éƒ¨",
                  title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
                  children: [],
                  relation: [],
                  info: {
                    type: "æ¨è¿›ä¸­",
                    name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
                    person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
                    with: "å¾å©·ã€ç‹ä½³",
                    finishTime: "2021-05-06",
                  },
                },
              ],
              relation: [
                {
                  name: "ç‰µå¤´å•ä½ï¼šå·¥ç¨‹é¡¹ç›®ç»„",
                  task: "å…³è”ä»»åŠ¡ï¼šå®Œæˆæ–°å»ºå…¬åŠ¡æœºæ£šé¡¹ç›®ç»“ç®—",
                },
              ],
              info: {
                type: "æ¨è¿›ä¸­",
                name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
                person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
                with: "å¾å©·ã€ç‹ä½³",
                finishTime: "2021-05-06",
              },
            },
            {
              name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
              title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
              children: [],
              relation: [],
              info: {
                type: "æ¨è¿›ä¸­",
                name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
                person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
                with: "å¾å©·ã€ç‹ä½³",
                finishTime: "2021-05-06",
              },
            },
          ],
          relation: [],
          info: {
            type: "æ¨è¿›ä¸­",
            name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
            person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
            with: "å¾å©·ã€ç‹ä½³",
            finishTime: "2021-05-06",
          },
        },
        {
          name: "ç‰µå¤´å•ä½ï¼šç ”å‘09éƒ¨",
          title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
          children: [
            {
              name: "ç‰µå¤´å•ä½ï¼šç ”å‘08éƒ¨",
              title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
              children: [],
              relation: [],
              info: {
                type: "æ¨è¿›ä¸­",
                name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
                person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
                with: "å¾å©·ã€ç‹ä½³",
                finishTime: "2021-05-06",
              },
            },
            {
              name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
              title: "ç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨å·¥ä½œè®¡åˆ’",
              children: [],
              relation: [],
              info: {
                type: "æ¨è¿›ä¸­",
                name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
                person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
                with: "å¾å©·ã€ç‹ä½³",
                finishTime: "2021-05-06",
              },
            },
          ],
          relation: [],
          info: {
            type: "æ¨è¿›ä¸­",
            name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
            person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
            with: "å¾å©·ã€ç‹ä½³",
            finishTime: "2021-05-06",
          },
        },
        {
          name: "æ‰¿åŠäººå‘˜ï¼šç ”å‘09éƒ¨ã€ç ”å‘äºŒéƒ¨",
          title: "å­ä»»åŠ¡ï¼šç ”å‘ä¸€éƒ¨äº§å“è®¾è®¡éƒ¨4æœˆç¬¬ä¸€å‘¨",
          children: [],
          relation: [],
          info: {
            type: "æ¨è¿›ä¸­",
            name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
            person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
            with: "å¾å©·ã€ç‹ä½³",
            finishTime: "2021-05-06",
          },
        },
      ],
      relation: [
        {
          name: "ç‰µå¤´å•ä½ï¼šå·¥ç¨‹é¡¹ç›®ç»„",
          task: "å…³è”ä»»åŠ¡ï¼šå®Œæˆæ–°å»ºå…¬åŠ¡æœºæ£šé¡¹ç›®ç»“ç®—",
        },
        {
          name: "ç‰µå¤´å•ä½ï¼šå·¥ç¨‹é¡¹ç›®ç»„",
          task: "å…³è”ä»»åŠ¡ï¼šå®Œæˆæ–°å»ºå…¬åŠ¡æœºæ£šé¡¹ç›®ç»“ç®—",
        },
      ],
      info: {
        type: "æ¨è¿›ä¸­",
        name: "ç‰µå¤´å•ä½ï¼šç ”å‘ä¸€éƒ¨",
        person: "ç‹é›·é›·ã€æå©·ã€è‚–å‡¯ç‚œã€æä½³",
        with: "å¾å©·ã€ç‹ä½³",
        finishTime: "2021-05-06",
      },
    };

    const fontSize = 12;
    const minCellWidth = 240;
    const scaleRange = [0.2, 4];
    const NODE_SIZE = [60, 360]; //èŠ‚ç‚¹é—´è·(é«˜/æ°´å¹³)
    const textPadding = 5; //æ–‡å­—ä¸æ–¹æ¡†é—´è·,æ³¨ï¼šå›ºå®šå€¼5
    const rectMinWidth = 50; //èŠ‚ç‚¹æ–¹æ¡†é»˜è®¤æœ€å°ï¼Œ
    const circleR = 5; //åœ†åœˆåŠå¾„
    const textSpace = 15; //å¤šè¡Œæ–‡å­—é—´è·

    /******************************* */

    /**
     * æ•°ç»„æ·±åº¦è®¡ç®—
     * */
    function fetchDepth(obj) {
      let depthNum = 0;
      function treeDepthGrade(obj, level = 0) {
        depthNum = Math.max(depthNum, level);
        if (obj.children.length > 0) {
          obj.children.forEach((v, i) => {
            treeDepthGrade(v, level + 1);
          });
        }
      }
      treeDepthGrade(obj);

      return depthNum;
    }

    /**
     * UUIDç”Ÿæˆ
     * */
    function uuid() {
      function s4() {
        return Math.floor((1 + Math.random()) * 0x10000)
          .toString(16)
          .substring(1);
      }

      return (
        s4() +
        s4() +
        "-" +
        s4() +
        "-" +
        s4() +
        "-" +
        s4() +
        "-" +
        s4() +
        s4() +
        s4()
      );
    }
    /*********************** */

    let treeContainer;
    const relationData = relationBasicData;

    function initTree() {
      const margin = { top: 0, right: 0, bottom: 0, left: 0 };
      const treeWidth = document.getElementById("relation").offsetWidth; //treeå®¹å™¨å®½
      const treeHeight = document.getElementById("relation").offsetHeight; //treeå®¹å™¨é«˜
      const centralX = treeWidth / 2;
      const centralY = treeHeight / 2;

      //svgæ ‡ç­¾
      const svg = d3
        .select("#relation")
        .append("svg")
        .attr("class", "tree-svg")
        .attr("width", treeWidth)
        .attr("height", treeHeight)
        .attr("font-size", fontSize);

      //gæ ‡ç­¾
      treeContainer = svg
        .append("g")
        .attr("class", "container")
        .attr("transform", `translate(${margin.left},${margin.top}) scale(1)`);

      const zoom = d3
        .zoom()
        .scaleExtent(scaleRange)
        .on("zoom", function() {
          return treeContainer.attr("transform", d3.event.transform);
        });
      //åŠ¨ç”»æŒç»­æ—¶é—´
      treeContainer
        .transition()
        .duration(750)
        .call(zoom.transform, d3.zoomIdentity);
      svg.call(zoom);

      initTreeCell(relationData, { x: centralX, y: centralY });
    }

    function updateTree(source, { x, y }) {
      const treeNodeSize = d3
        .tree()
        .nodeSize(NODE_SIZE)
        .separation((a, b) => {
          let result =
            a.parent === b.parent && !a.children && !b.children ? 1 : 2;
          if (result > 1) {
            let length = 0;
            length = a.children ? length + a.children.length : length;
            length = b.children ? length + b.children.length : length;
            let relationLens = 0;
            const aR = a.data && a.data.relation ? a.data.relation.length : 0;
            const bR = b.data && b.data.relation ? b.data.relation.length : 0;
            relationLens = aR + bR;
            result = length / 2 + 1.5 + relationLens / 2;
          }
          return result;
        });
      const tree = treeNodeSize(rootRelation);

      const nodes = tree.descendants(); //è¿”å›åä»£èŠ‚ç‚¹æ•°ç»„ï¼Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹ä¸ºè‡ªèº«ï¼Œç„¶åä¾æ¬¡ä¸ºæ‰€æœ‰å­èŠ‚ç‚¹çš„æ‹“æ‰‘æ’åº
      const links = tree.links(); //è¿”å›å½“å‰ node çš„ links æ•°ç»„, å…¶ä¸­æ¯ä¸ª link å®šä¹‰äº† sourceçˆ¶èŠ‚ç‚¹, target å­èŠ‚ç‚¹å±æ€§ã€‚
      nodes.forEach((d) => {
        //å·¦å³2éƒ¨åˆ†ï¼Œè®¾ç½®ä»¥ä¸­å¿ƒç‚¹ä¸ºåœ†ç‚¹(é»˜è®¤å·¦ä¸Šè§’ä¸ºè¿œç‚¹)
        d.y = (d.y ? d.y : 0) + y - rootNodeLength / 2;
        d.x = (d.x ? d.x : 0) + x - rootNodeLength / 3;
      });
      const className = `rgNode`;

      //æ ¹æ®classåç§°è·å–å·¦æˆ–è€…å³çš„gèŠ‚ç‚¹ï¼Œè¾¾åˆ°åˆ†å—æ›´æ–°
      const node = treeContainer
        .selectAll(`g.${className}`)
        .data(nodes, (d) => d.id);

      //æ–°å¢èŠ‚ç‚¹ï¼Œtreeä¼šæ ¹æ®æ•°æ®å†…çš„childrenæ‰©å±•ç›¸å…³èŠ‚ç‚¹
      const nodeEnter = node
        .enter()
        .append("g")
        .attr("id", (d) => `g${d.id}`)
        .attr("class", className)
        .attr("transform", (d) => `translate(${source.y0},${source.x0})`)
        .attr("fill-opacity", 0)
        .attr("stroke-opacity", 0);

      nodeEnter.each((d) => {
        if (d.depth > 0) {
          //éæ ¹èŠ‚ç‚¹ä¸”æ— å­èŠ‚ç‚¹
          drawText(`g${d.id}`); //ç”»æ–‡æœ¬

          if (d.data.relation) {
            d.data.relation.forEach((ele) => {
              drawTsText(`g${d.id}`, ele); //ç”»å­æ–‡æœ¬
            });
          }
          drawRect(`g${d.id}`); //ç”»æ–¹æ¡†
        }
        if (d.depth > 0 && d._children) {
          //éæ ¹èŠ‚ç‚¹ä¸”æœ‰å­èŠ‚ç‚¹
          let xDistance = minCellWidth;

          const circle = drawCircle(`g${d.id}`, circleR); //ç”»åœ†åœˆ
          circle
            .attr("transform", `translate(${xDistance},0)`)
            .on("click", (d) => {
              d.depth !== 0 && clickNode(d, { x, y }); //æ ¹èŠ‚ç‚¹ä¸æ‰§è¡Œç‚¹å‡»äº‹ä»¶
            }); //ä¿®æ”¹åœ†åœˆå±æ€§
        }
      });

      // æ›´æ–°èŠ‚ç‚¹ï¼šèŠ‚ç‚¹enterå’Œexitæ—¶éƒ½ä¼šè§¦å‘treeæ›´æ–°
      const nodeUpdate = node
        .merge(nodeEnter)
        .transition()
        .duration(750)
        .attr("transform", (d) => `translate(${d.y - rectMinWidth / 2},${d.x})`)
        .attr("fill-opacity", 1)
        .attr("stroke-opacity", 1);

      // ç§»é™¤èŠ‚ç‚¹:treeç§»é™¤æ‰æ•°æ®å†…ä¸åŒ…å«çš„èŠ‚ç‚¹(å³ï¼Œchildren = false)
      const nodeExit = node
        .exit()
        .transition()
        .duration(750)
        .remove()
        .attr("transform", (d) => `translate(${source.y},${source.x})`)
        .attr("fill-opacity", 0)
        .attr("stroke-opacity", 0);

      createLineLink(links, source, className);

      // Stash the old positions for transition.
      rootRelation.eachBefore((d) => {
        d.x0 = d.x;
        d.y0 = d.y;
      });
    }

    function createLineLink(links, source, className) {
      // Update the links æ ¹æ® classNameæ¥å®ç°åˆ†å—æ›´æ–°
      const link = treeContainer
        .selectAll(`path.${className}`)
        .data(links, (d) => d.target.id);

      // Enter any new links at the parent's previous position.
      //insertæ˜¯åœ¨gæ ‡ç­¾å‰é¢æ’å…¥ï¼Œé˜²æ­¢è¿æ¥çº¿æŒ¡ä½GèŠ‚ç‚¹å†…å®¹
      const linkEnter = link
        .enter()
        .insert("path", "g")
        .attr("class", className)
        .attr("d", (d) => {
          const o = { x: source.x0, y: source.y0 };
          return diagonal({ source: o, target: o });
        })
        .attr("fill", "none")
        .attr("stroke-width", 1)
        .attr("stroke", "#dddddd");
      // .attr("stroke-dasharray", "5, 5");

      // Transition links to their new position.
      link
        .merge(linkEnter)
        .transition()
        .duration(750)
        .attr("d", diagonal);

      // Transition exiting nodes to the parent's new position.
      link
        .exit()
        .transition()
        .duration(750)
        .remove()
        .attr("d", (d) => {
          const o = { x: source.x, y: source.y };
          return diagonal({ source: o, target: o });
        });
    }

    //ç‚¹å‡»æŸä¸ªèŠ‚ç‚¹
    function clickNode(d, pointXY) {
      if (!d._children && !d.children) {
        //æ— å­èŠ‚ç‚¹
        return;
      }
      //æ ¹æ®å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰childrenæ¥åˆ¤æ–­æ˜¯å±•å¼€è¿˜æ˜¯æ”¶ç¼©ï¼Œtrueæ”¶ç¼©ï¼Œfalseå±•å¼€
      //treeä¼šæ ¹æ®èŠ‚ç‚¹å†…æ˜¯å¦æœ‰childrenæ¥å‘ä¸‹æ‰©å±•
      d.children = d.children ? null : d._children;
      d3.select(`#g${d.id} .node-circle .node-circle-vertical`)
        .transition()
        .duration(750)
        .attr("stroke-width", d.children ? 0 : 1); //æ§åˆ¶èŠ‚ç‚¹ä¼¸ç¼©æ—¶çš„æ ‡è¯†åœ†åœˆ
      updateTree(d, pointXY);
    }

    //ç”»è¿æ¥çº¿
    function diagonal({ source, target }) {
      let s = source,
        d = target;
      return `M ${s.y} ${s.x}
                L ${(s.y + d.y) / 2} ${s.x},
                L ${(s.y + d.y) / 2} ${d.x},
                ${d.y} ${d.x}`;
    }

    //ç”»æ–‡æœ¬
    function drawText(id) {
      d3.select(`#${id}`)
        .append("text")
        .attr("y", 0)
        .attr("x", 0)
        .attr("text-anchor", "start")
        .style("font-size", fontSize)
        .text((d) => d.data.name);

      return d3
        .select(`#${id}`)
        .append("text")
        .attr("y", fontSize + 10)
        .attr("x", 0)
        .attr("text-anchor", "start")
        .style("font-size", fontSize)
        .attr("fill", "#333")
        .text((d) => d.data.title);
    }
    //ç”»å­æ–‡æœ¬
    function drawTsText(id, info) {
      let realh = document.getElementById(id).getBBox().height;
      let realX = document.getElementById(id).getBBox().x;
      let realY = document.getElementById(id).getBBox().y;
      const rgNode = d3
        .select(`#${id}`)
        .append("g")
        .attr("id", (d) => `rg${d.id}`)
        .attr(
          "transform",
          (d) => `translate(${realX + 60},${realY + realh + 30})`
        );

      rgNode
        .append("rect", "text")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", minCellWidth)
        .attr("height", 55)
        .attr("rx", 2) //åœ†è§’
        .attr("class", "tree-cell")
        .style("fill", "#ffffff");
      rgNode
        .append("text")
        .attr("x", 10)
        .attr("y", 20)
        .attr("fill", "#333")
        .text(info.name);
      rgNode
        .append("text")
        .attr("x", 10)
        .attr("y", fontSize + 30)
        .attr("fill", "#333")
        .text(info.task);
    }

    //ç”»æ–¹æ¡†é˜´å½±
    function drawFilter(id) {
      return d3
        .select(`#${id}`)
        .insert("defs", "rect")
        .append("filter")
        .attr("id", `f${id}`)
        .attr("x", 0)
        .attr("y", 0)
        .append("feGaussianBlur")
        .attr("in", "SourceGraphic")
        .attr("stdDeviation", "5");
    }
    //ç”»æ–¹æ¡†
    function drawRect(id) {
      let realw = document.getElementById(id).getBBox().width + 20; //è·å–gå®é™…å®½åº¦åï¼Œè®¾ç½®rectå®½åº¦
      let realh = document.getElementById(id).getBBox().height;

      const rectNode = d3.select(`#${id}`);
      rectNode
        .insert("rect", "text")
        .attr("x", -10)
        .attr("y", -20)
        .attr("width", minCellWidth)
        .attr("height", 55)
        .attr("rx", 2) //åœ†è§’
        .attr("class", "tree-cell")
        .style("fill", "#ffffff");

      // å·¦ä¾§ç«–æ¡
      rectNode
        .append("svg:rect")
        .attr("width", 2)
        .attr("height", 55)
        .attr("x", -10)
        .attr("y", -20)
        .attr("fill", "#2196f3");

      // çŠ¶æ€ç¯
      rectNode
        .append("circle")
        .attr("r", 5)
        .attr("cx", minCellWidth - 20)
        .attr("cy", -10)
        .attr("fill", "#4caf50");
    }

    //ç”»circle
    function drawCircle(id, radius) {
      let gMark = d3
        .select(`#${id}`)
        .append("g")
        .attr("class", "node-circle")
        .attr("stroke", "#ffa500")
        .attr("stroke-width", 1);

      gMark
        .append("circle")
        .attr("fill", "none")
        .attr("r", (d) => (d.depth === 0 ? 0 : radius)) //æ ¹èŠ‚ç‚¹ä¸è®¾ç½®åœ†åœˆ
        .attr("fill", "#ffffff");
      let padding = radius - 2;
      gMark.append("path").attr("d", `m -${padding} 0 l ${2 * padding} 0`); //æ¨ªçº¿

      gMark
        .append("path") //ç«–çº¿ï¼Œæ ¹æ®å±•å¼€/æ”¶ç¼©åŠ¨æ€æ§åˆ¶æ˜¾ç¤º
        .attr("d", `m 0 -${padding} l 0 ${2 * padding}`)
        .attr("stroke-width", 0)
        .attr("class", "node-circle-vertical");
      return gMark;
    }

    //æœ« èŠ‚ç‚¹ è¾¹æ¡†é¢œè‰²
    function getRectStorke(name) {
      switch (name) {
        case "æ¨è¿›ä¸­":
          return "green";
        case "ä¾›åº”å•†":
          return "skyblue";
        case "åˆä¼™äºº":
          return "#FF9800";
        default:
          return "gray";
      }
    }

    let rootNodeLength;
    function createTreeRootNode(container, { x, y }, info) {
      const rootNode = container
        .append("g")
        .attr("id", "treeRoot")
        .attr("transform", `translate(${x},${y})`);
      const title = rootNode
        .append("text")
        .attr("x", 0)
        .attr("y", 0)
        .attr("font-size", fontSize)
        .text(info.name);
      rootNode
        .append("text")
        .attr("x", 0)
        .attr("y", fontSize + 10)
        .attr("font-size", fontSize)
        .text(info.title);

      const rootNodeLens = info.name.length * fontSize + 30;
      //   const cellWidth =
      //     rootNodeLens > minCellWidth ? rootNodeLens : minCellWidth;

      let realw = document.getElementById("treeRoot").getBBox().width + 20; //è·å–gå®é™…å®½åº¦åï¼Œè®¾ç½®rectå®½åº¦
      const cellWidth = realw;
      rootNodeLength = cellWidth;
      rootNode
        .insert("rect", "text")
        .attr("class", "tree-cell")
        .attr("width", cellWidth)
        .attr("height", 55)
        .attr("x", -10)
        .attr("y", -20)
        .attr("fill", "#fff")
        .attr("rx", 2); //åœ†è§’

      // å·¦ä¾§ç«–æ¡
      rootNode
        .append("svg:rect")
        .attr("class", "tree-cell")
        .attr("width", 2)
        .attr("height", 55)
        .attr("x", -10)
        .attr("y", -20)
        .attr("fill", "#2196f3");

      // çŠ¶æ€ç¯
      rootNode
        .append("circle")
        .attr("r", 5)
        .attr("cx", cellWidth - 20)
        .attr("cy", -10)
        .attr("fill", "#4caf50");

      // å¸½å­æ ‡ç­¾
      rootNode
        .append("text")
        .attr("x", -8)
        .attr("y", -16)
        .attr("fill", "#ff0")
        .style("transform", "rotate(-30deg)")
        .attr("font-size", 24)
        .text("ğŸ‘‘");
    }

    function createTreeChildCell(container, { x, y }, info) {
      const cellNode = container
        .append("g")
        .attr("transform", `translate(${x},${y})`);
      const cellNodeLens = info.name.length * fontSize + 30;
      const cellWidth =
        cellNodeLens > minCellWidth ? cellNodeLens : minCellWidth;
      cellNode
        .append("svg:rect")
        .attr("class", "tree-cell")
        .attr("width", cellWidth)
        .attr("height", 55)
        .attr("x", -10)
        .attr("y", -20)
        .attr("fill", "#fff")
        .attr("rx", 2); //åœ†è§’

      // å·¦ä¾§ç«–æ¡
      cellNode
        .append("svg:rect")
        .attr("class", "tree-cell")
        .attr("width", 2)
        .attr("height", 55)
        .attr("x", -10)
        .attr("y", -20)
        .attr("fill", "#2196f3");

      // çŠ¶æ€ç¯
      cellNode
        .append("circle")
        .attr("r", 5)
        .attr("cx", cellWidth - 20)
        .attr("cy", -10)
        .attr("fill", "#4caf50");

      // å¸½å­æ ‡ç­¾
      cellNode
        .append("text")
        .attr("x", -8)
        .attr("y", -16)
        .attr("fill", "#ff0")
        .style("transform", "rotate(-30deg)")
        .attr("font-size", 24)
        .text("ğŸ‘‘");
      cellNode
        .append("text")
        .attr("x", 0)
        .attr("y", 0)
        .attr("font-size", fontSize)
        .text(info.name);
      cellNode
        .append("text")
        .attr("x", 0)
        .attr("y", fontSize + 10)
        .attr("font-size", fontSize)
        .text(info.title);
    }

    let rootRelation;
    function initTreeCell(treeRelation, { x, y }) {
      createTreeRootNode(
        treeContainer,
        { x: centralX / 2, y: centralY },
        relationData
      );
      const temp = d3.hierarchy(treeRelation);
      temp.x0 = x;
      temp.y0 = y;
      temp.descendants().forEach((d) => {
        d._children = d.children; //æ·»åŠ _childrenå±æ€§ï¼Œç”¨äºå®ç°ç‚¹å‡»æ”¶ç¼©åŠå±•å¼€åŠŸèƒ½
        d.id = "cell" + uuid(); //ç»‘å®šå”¯ä¸€æ ‡è¯†ID
      });
      rootRelation = temp;
      //   this.update(temp, {
      //     x: this.centralPoint[0],
      //     y: this.centralPoint[1],
      //   });
      updateTree(temp, { x, y });
    }

    initTree();
  },
};
</script>
<style>
#relation {
  width: 100%;
  height: 100%;
}
.tree-cell {
  background: #ffffff;
  color: #333333;
  -webkit-filter: drop-shadow(0 0 5px rgb(128 145 165 / 40%));
  /* filter: url(#drop-shadow); */
}
</style>
